<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Running Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050609;
      --bg-card: #151822;
      --accent: #f5c84c;
      --text: #f6f7fb;
      --muted: #8a8fa3;
      --error: #ff6666;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      background: radial-gradient(circle at top left, #262a3d, #050609 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 32px 32px;
    }
    .dashboard {
      max-width: 1200px;
      width: 100%;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .title {
      font-size: 24px;
      font-weight: 700;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #3bd675;
    }
    .clock {
      font-size: 20px;
      font-weight: 600;
      text-align: right;
    }
    .clock small {
      display: block;
      font-size: 12px;
      color: var(--muted);
      font-weight: 400;
    }

    .date-range {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--muted);
    }
    .date-range label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .date-range input[type="date"] {
      background: #10121b;
      border: 1px solid #26293a;
      color: var(--text);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }
    .date-range button {
      background: var(--accent);
      color: #11121a;
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 18px 20px;
      min-height: 120px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
      position: relative;
      overflow: hidden;
    }
    .card-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .card-main {
      font-size: 32px;
      font-weight: 700;
    }
    .card-main span.small {
      font-size: 18px;
      font-weight: 500;
      color: var(--muted);
      margin-left: 4px;
    }
    .card-sub {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .card-highlight {
      border: 1px solid rgba(245, 200, 76, 0.45);
    }

    .error-text {
      color: var(--error);
      font-size: 12px;
      margin-top: 8px;
    }

    /* Quote card layout */
    .card-quote {
      grid-column: span 2;
    }
    .quote-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .quote-text {
      flex: 1 1 auto;
    }
    .quote-image {
    flex: 0 0 auto;
    max-height: 72px;
    max-width: 72px;
    height: auto;
    width: auto;
    object-fit: contain;
    border-radius: 50%;
    transform-origin: 50% 90%;    /* pivot near the chin */
    animation: headshake 1.6s ease-in-out infinite;
  }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 600px) {
      body { padding: 12px; }
      .grid {
        grid-template-columns: 1fr;
      }
      .card-quote {
        grid-column: span 1;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .clock {
        text-align: left;
      }
    }
  .card-quote .card-main {
  font-size: 24px;   /* try 22–24px; adjust to taste */
  line-height: 1.3;
}
@keyframes headshake {
  0%   { transform: rotate(0deg); }
  20%  { transform: rotate(-6deg); }
  40%  { transform: rotate(6deg); }
  60%  { transform: rotate(-4deg); }
  80%  { transform: rotate(4deg); }
  100% { transform: rotate(0deg); }
}

document.addEventListener('DOMContentLoaded', () => {
  setDefaultRange();
  setRandomQuote();
  updateClock();
  setInterval(updateClock, 30 * 1000);

  const apply = document.getElementById('apply-range');
  if (apply) {
    apply.addEventListener('click', () => {
      setRandomQuote();
      fetchData();
    });
  }

  // NEW: tap Bennett's head to refresh data + quote
  const bennettHead = document.querySelector('.quote-image');
  if (bennettHead) {
    bennettHead.addEventListener('click', () => {
      setRandomQuote();
      fetchData();
    });
  }

  fetchData();
});

    
  </style>
</head>
<body>
  <div class="dashboard">
    <header>
      <div>
        <div class="title">Running Dashboard</div>
        <div class="status">
          <span class="status-dot"></span>
          <span id="connection-status">Connected</span>
        </div>
      </div>
      <div class="clock">
        <span id="clock-time">00:00</span>
        <small id="clock-date">Loading…</small>
      </div>
    </header>

    <div class="date-range">
      <strong>Date range:</strong>
      <label>
        From
        <input type="date" id="start-date" />
      </label>
      <label>
        To
        <input type="date" id="end-date" />
      </label>
      <button id="apply-range">Apply</button>
      <span id="range-label"></span>
    </div>

    <div id="error-message" class="error-text" style="display:none;"></div>

    <div class="grid">
      <!-- Selected range: distance + runs -->
      <div class="card">
        <div class="card-title">This Range</div>
        <div class="card-main">
          <span id="range-km">0.0</span>
          <span class="small">km</span>
        </div>
        <div class="card-sub">
          <span id="range-runs">0</span> runs in range
        </div>
      </div>

      <!-- Average pace -->
      <div class="card">
        <div class="card-title">Avg Pace</div>
        <div class="card-main">
          <span id="avg-pace">0:00</span>
          <span class="small">per kilometer</span>
        </div>
        <div class="card-sub">
          Average pace for range
        </div>
      </div>

      <!-- Longest run -->
      <div class="card">
        <div class="card-title">Longest Run</div>
        <div class="card-main">
          <span id="longest-run">0.0</span>
          <span class="small">kilometers</span>
        </div>
        <div class="card-sub">
          Longest single run in range
        </div>
      </div>

      <!-- Calories -->
      <div class="card card-highlight">
        <div class="card-title">Calories Burned</div>
        <div class="card-main">
          <span id="calories">0</span>
          <span class="small"></span>
        </div>
        <div class="card-sub">
          Estimated calories from runs
        </div>
      </div>

      <!-- This Month (approx last 30 days) -->
      <div class="card card-highlight">
        <div class="card-title">This Month</div>
        <div class="card-main">
          <span id="month-km">0.0</span>
          <span class="small">kilometers</span>
        </div>
        <div class="card-sub">
          Total run distance (30 days)
        </div>
      </div>

      <!-- All-time runs -->
      <div class="card card-highlight">
        <div class="card-title">Total Runs</div>
        <div class="card-main">
          <span id="all-runs">0</span>
        </div>
        <div class="card-sub">
          All-time runs
        </div>
      </div>

      <!-- All-time distance -->
      <div class="card">
        <div class="card-title">All-Time Distance</div>
        <div class="card-main">
          <span id="all-km">0.0</span>
          <span class="small">kilometers</span>
        </div>
        <div class="card-sub">
          Sum of all runs
        </div>
      </div>

      <!-- Quote card -->
      <div class="card card-quote">
        <div class="quote-inner">
          <div class="quote-text">
            <div class="card-title">Coach Bennett</div>
            <div class="card-main" id="quote-text">
              Every run has a purpose.
            </div>
            <div class="card-sub" id="quote-sub"></div>
          </div>
          <img
            class="quote-image"
            src="https://raw.githubusercontent.com/c15c/stravarun/refs/heads/main/bennett_head.png"
            alt="Coach Bennett"
          />
        </div>
      </div>
    </div>
  </div>

  <script>
    const runningQuotes = [
      "Every finish line is a starting line in disguise",
      "We do hard things not so they become easy, but so we can take on even harder things",
      "You can get better at running, while not running",
      "If you aren't running, you are recovering",
      "Celebrate!",
      "This is about running, and it's also not about running",
      "Easy runs should feel easy",
      "Run smart",
      "There are no guarantees when you cross the starting line",
      "You are a bad-ass!",
      "Running isn't boring, but some runners are.",
      "Play at running.",
      "Release the Kraken!",
      "We don't race to prove we're runners, we race to celebrate being runners.",
      "Count your victories in as many ways as you can",
      "Every run has a purpose."
    ];

    function setRandomQuote() {
      const quoteEl = document.getElementById('quote-text');
      if (!quoteEl || runningQuotes.length === 0) return;
      const idx = Math.floor(Math.random() * runningQuotes.length);
      quoteEl.textContent = runningQuotes[idx];
    }

    function updateClock() {
      const now = new Date();
      const timeEl = document.getElementById('clock-time');
      const dateEl = document.getElementById('clock-date');
      if (!timeEl || !dateEl) return;

      const hours = now.getHours().toString().padStart(2, '0');
      const mins = now.getMinutes().toString().padStart(2, '0');
      timeEl.textContent = `${hours}:${mins}`;

      const options = { weekday: 'long', day: 'numeric', month: 'short' };
      dateEl.textContent = now.toLocaleDateString(undefined, options);
    }

    function setDefaultRange() {
      const startInput = document.getElementById('start-date');
      const endInput = document.getElementById('end-date');
      if (!startInput || !endInput) return;

      const today = new Date();
      const day = today.getDay(); // 0=Sun,1=Mon,...6=Sat
      const diffToMonday = (day + 6) % 7;

      const monday = new Date(
        today.getFullYear(),
        today.getMonth(),
        today.getDate() - diffToMonday,
        0, 0, 0, 0
      );

      endInput.value = today.toISOString().slice(0, 10);
      startInput.value = monday.toISOString().slice(0, 10);
    }

    function updateRangeLabel(range) {
      const label = document.getElementById('range-label');
      if (!label || !range) return;
      const start = new Date(range.start);
      const end = new Date(range.end);
      label.textContent =
        `Showing runs from ${start.toLocaleDateString()} to ${end.toLocaleDateString()}`;
    }

    async function fetchData() {
      const errorEl = document.getElementById('error-message');
      if (errorEl) errorEl.style.display = 'none';

      const startInput = document.getElementById('start-date');
      const endInput = document.getElementById('end-date');

      const params = new URLSearchParams();
      if (startInput && startInput.value) params.append('start', startInput.value);
      if (endInput && endInput.value) params.append('end', endInput.value);

      const url = params.toString() ? `/api/strava?${params}` : '/api/strava';

      try {
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(`API ${res.status}`);
        }
        const data = await res.json();

        updateRangeLabel(data.range);

        const s = data.summary || {};
        const activities = data.activities || [];

        document.getElementById('range-km').textContent =
          s.totalKm != null ? s.totalKm.toFixed(1) : '0.0';
        document.getElementById('range-runs').textContent =
          s.totalRuns != null ? s.totalRuns : activities.length || 0;
        document.getElementById('avg-pace').textContent =
          s.avgPacePerKm || 'N/A';
        document.getElementById('longest-run').textContent =
          s.longestRunKm != null ? s.longestRunKm.toFixed(1) : '0.0';
        document.getElementById('calories').textContent =
          s.calories != null ? s.calories.toString() : '0';

        document.getElementById('all-km').textContent =
          s.allTimeKm != null ? s.allTimeKm.toFixed(1) : '0.0';
        document.getElementById('all-runs').textContent =
          s.allTimeRuns != null ? s.allTimeRuns.toString() : '0';

        const monthKmEl = document.getElementById('month-km');
        if (monthKmEl) {
          const now = Date.now();
          const thirtyAgo = now - 30 * 24 * 60 * 60 * 1000;
          const monthKm = activities
            .filter((a) => new Date(a.start_date).getTime() >= thirtyAgo)
            .reduce((sum, a) => sum + a.distance / 1000, 0);
          monthKmEl.textContent = monthKm.toFixed(1);
        }
      } catch (err) {
        console.error(err);
        if (errorEl) {
          errorEl.textContent =
            'Failed to load data from Strava. Please try again in a moment.';
          errorEl.style.display = 'block';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      setDefaultRange();
      setRandomQuote();
      updateClock();
      setInterval(updateClock, 30 * 1000);

      const apply = document.getElementById('apply-range');
      if (apply) {
        apply.addEventListener('click', () => {
          setRandomQuote();
          fetchData();
        });
      }

      fetchData();
    });
  </script>
</body>
</html>
